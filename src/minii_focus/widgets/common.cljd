(ns minii-focus.widgets.common
  (:require
   ["package:flutter/material.dart" :as m]
   ["dart:core" :as dart-core]
   ["dart:convert" :as json]
   [minii-focus.core.components.core :as comp]
   [minii-focus.core.components.tokens :as tokens]
   [minii-focus.core.utils.logger :as logger]))

(defn parse-json
  "Parse JSON string safely"
  [json-str]
  (if (and json-str (not (empty? json-str)))
    (try
      (json/jsonDecode json-str)
      (catch Exception _ []))
    []))

(defn format-yyyymmdd [yyyymmdd]
  (let [year (int (/ yyyymmdd 10000))
        month-day (mod yyyymmdd 10000)
        month (int (/ month-day 100))
        day (mod month-day 100)]
    (str year "-" month "-" day)))

(defn format-date-time
  "Format date time (display creation time)
  Accepts either DateTime object or int timestamp (in seconds or milliseconds)
  Note: Task.createdAt is in seconds"
  [date-time]
  (if (nil? date-time)
    "Unknown"
    (try
      (let [is-num (number? date-time)
            now (dart-core/DateTime.now)
            now-ms (.millisecondsSinceEpoch now)
            ;; Convert date-time to milliseconds
            created-ms (if is-num
                         ;; It's a number (timestamp)
                         (if (>= date-time 1000000000000)
                           ;; Already in milliseconds
                           date-time
                           ;; In seconds, convert to milliseconds (Task.createdAt is in seconds)
                           (* date-time 1000))
                         ;; Assume it's already a DateTime object
                         (try
                           (.millisecondsSinceEpoch date-time)
                           (catch Exception e
                             (logger/error "widgets/common" "Failed to get millisecondsSinceEpoch from DateTime"
                                           {:date-time-str (str date-time)
                                            :error (str e)})
                             (throw e))))
            ;; Create DateTime object for accessing .month and .day
            created-dt (try
                         (dart-core/DateTime.fromMillisecondsSinceEpoch created-ms)
                         (catch Exception e
                           (logger/error "widgets/common" "Failed to create DateTime from milliseconds"
                                         {:created-ms created-ms
                                          :error (str e)})
                           (throw e)))
            diff-ms (- now-ms created-ms)
            ms-per-day 86400000
            diff-days (int (/ diff-ms ms-per-day))
            result (cond
                     (= diff-days 0) "Today"
                     (= diff-days 1) "Yesterday"
                     (< diff-days 7) (str diff-days " days ago")
                     :else (try
                             (str (.month created-dt) "/" (.day created-dt))
                             (catch Exception e
                               (logger/error "widgets/common" "Failed to access month/day from DateTime"
                                             {:created-dt-str (str created-dt)
                                              :error (str e)})
                               "Unknown")))]
        result)
      (catch Exception e
        (logger/error "widgets/common" "format-date-time error"
                      {:date-time date-time
                       :date-time-str (str date-time)
                       :error (str e)})
        "Unknown"))))

(defn format-timer
  "Format seconds to MM:SS"
  [seconds]
  (let [m (int (/ seconds 60))
        s (mod seconds 60)]
    (str (if (< m 10) "0" "") m ":" (if (< s 10) "0" "") s)))

(defn loading-indicator []
  (m/Center
   .child (m/CircularProgressIndicator)))

(defn empty-state [text]
  (m/Center
   .child (comp/mongol-text-block
           {:text text
            :style (m/TextStyle
                    .color (tokens/color :text-weak))})))

(defn get-weight-color [weight]
  (cond
    (>= weight 0.7) m/Colors.green
    (>= weight 0.4) m/Colors.orange
    :else m/Colors.grey))

(defn weight-history-chart
  "Weight change chart component
  
  Parameters:
  - weight-history: vector of {:timestamp int, :weight double}
  - get-color-fn: (optional) fn [weight] -> Color"
  [{:keys [weight-history get-color-fn]}]
  (let [color-fn (or get-color-fn get-weight-color)
        sorted-history (sort-by :timestamp > (take 7 weight-history))
        max-weight (if (empty? sorted-history) 1.0 (apply max (map :weight sorted-history)))
        min-weight (if (empty? sorted-history) 0.0 (apply min (map :weight sorted-history)))
        range-weight (- max-weight min-weight)
        normalized-history (if (zero? range-weight)
                            (map (fn [item] (assoc item :normalized 0.5)) sorted-history)
                            (map (fn [item]
                                   (assoc item
                                          :normalized
                                          (/ (- (:weight item) min-weight) range-weight)))
                                 sorted-history))]
    (m/Container
     .height 80
     .margin (m/EdgeInsets.symmetric :vertical (tokens/space :s))
     .child (m/Row
            .crossAxisAlignment m/CrossAxisAlignment.end
            .children
            (vec (map (fn [item]
                       (m/Expanded
                        .child (m/Container
                               .margin (m/EdgeInsets.symmetric :horizontal 2)
                               .height (* 60 (:normalized item))
                               .decoration (m/BoxDecoration
                                           .color (color-fn (:weight item))
                                           .borderRadius (m/BorderRadius.circular 4)))))
                     normalized-history))))))

(defn overload-warning [{:keys [count limit]}]
  (m/Container
   .margin (m/EdgeInsets.symmetric
            :horizontal (tokens/space :m)
            :vertical (tokens/space :s))
   .padding (m/EdgeInsets.all (tokens/space :m))
   .decoration (m/BoxDecoration
                .color m/Colors.orange.shade50
                .border (m/Border.all
                         :color m/Colors.orange.shade300
                         :width 1)
                .borderRadius (m/BorderRadius.circular 8))
   .child (m/Row
           .children
           [(m/Icon
             m/Icons.warning
             .color m/Colors.orange.shade700
             .size 20)
            (m/SizedBox .width (tokens/space :s))
            (m/Expanded
             .child (comp/mongol-text-block
                     {:text (str "âš  Overloaded: "
                                 count
                                 " items (limit: "
                                 limit
                                 ")")
                      :style (m/TextStyle
                              .fontSize (tokens/font-size :s)
                              .color m/Colors.orange.shade900
                              .fontWeight m/FontWeight.w500)}))])))

(defn accuracy-card [{:keys [accuracy completed total]}]
  (m/Container
   .margin (m/EdgeInsets.symmetric
            :horizontal (tokens/space :m)
            :vertical (tokens/space :s))
   .padding (m/EdgeInsets.all (tokens/space :m))
   .decoration (m/BoxDecoration
                .color (tokens/color :bg-focus)
                .borderRadius (m/BorderRadius.circular 8))
   .child (m/Column
           .crossAxisAlignment m/CrossAxisAlignment.start
           .children
           [(comp/mongol-text-block
             {:text "Forecast Accuracy (Last 7 Days)"
              :style (m/TextStyle
                      .fontSize (tokens/font-size :m)
                      .fontWeight m/FontWeight.bold)})
            (m/SizedBox .height (tokens/space :s))
            (m/Row
             .mainAxisAlignment m/MainAxisAlignment.spaceBetween
             .children
             [(m/Column
               .crossAxisAlignment m/CrossAxisAlignment.start
               .children
               [(comp/mongol-text-block
                 {:text (str (int (* accuracy 100)) "%")
                  :style (m/TextStyle
                          .fontSize (tokens/font-size :xl)
                          .fontWeight m/FontWeight.bold
                          .color (cond
                                   (>= accuracy 0.7) m/Colors.green
                                   (>= accuracy 0.5) m/Colors.orange
                                   :else m/Colors.red))})
                (comp/mongol-text-block
                 {:text (str "Completed " completed " / " total)
                  :style (m/TextStyle
                          .fontSize (tokens/font-size :s)
                          .color (tokens/color :text-weak))})])
              (m/Container
               .width 100
               .height 8
               .decoration (m/BoxDecoration
                            .color (tokens/color :bg-weak)
                            .borderRadius (m/BorderRadius.circular 4))
               .child (m/Container
                       .width (* 100 accuracy)
                       .height 8
                       .decoration (m/BoxDecoration
                                    .color (cond
                                             (>= accuracy 0.7) m/Colors.green
                                             (>= accuracy 0.5) m/Colors.orange
                                             :else m/Colors.red)
                                    .borderRadius (m/BorderRadius.circular 4))))])])))
